{% extends 'common/base.html' %}
{% load url from future %}

{% block content %}
        <div class="row-fluid">
          <div class="span5">
              <div data-bind="visible: breadcrumbs.length > 0">
                <ul id="breadcrumbs" class="breadcrumb" data-bind="foreach: breadcrumbs">
                    <li data-bind="visible: ! $parent.isLast($data)">
                        <a data-bind="text: name, click: action"></a>
                        <span class="divider">/</span>
                    </li>
                    <li class="active" data-bind="visible: $parent.isLast($data)">
                        <span data-bind="text: name"></span>
                    </li>
                </ul>
            </div>
            <div class="well" style="display:none" data-bind="visible: $root">
                <h1>
                  Manage Stand Groups
                  <div class="btn-group pull-right">
                    <button class="btn btn-large" data-bind="disable: newStratum(), click: createStratum"><i class="icon-arrow-left"></i> properties</button>
                    <button class="btn btn-large" data-bind="disable: newStratum(), click: createStratum"><i class="icon-plus"></i> new stand group</button>
                  </div>
                </h1>

                <div class="row-fluid">
                    
                    <div class="span6">
                        <p>You have applied stand groups to <span data-bind="text: appliedStrataTotal"></span> of <span data-bind="text: standTotal"></span> stands.</p>
                        <div class="progress">
                          <div class="bar bar-success" data-bind="style: { width: (appliedStrataTotal/strataList().length)/100+'%' }"></div>
                        </div>
                    </div>
                </div>
                <!-- strata list -->
                <div class="row-fluid">
                    <div class="span12">
                        <div data-bind="visible: strataList().length && ! newStratum()">
                            <ul class="nav nav-tabs nav-stacked strata-list" data-bind="foreach: strataList()">
                                <li data-bind="attr: { 'data-sid': uid }"><a><span data-bind="text: name"></span></a></li>
                            </ul>
                        </div>
                    </div>
                </div>


                <!-- property has no strata -->
                <div data-bind="visible: !strataList().length && ! newStratum()">
                    You have no stand groups.
                </div>

                <!-- creating a new stratum -->
                <div data-bind="if: newStratum()">
                    <h2>Create a New Stand Group</h2>
                    <div data-bind="with: newStratum">
                        
                        <div data-bind="visible: ! standList().length">
                            <h3>Stand Group Name</h3>
                            <input type="text" class="span12" placeholder="Stand Group Name" autofocus data-bind="value: name, valueUpdate: 'keyup'"/>
                            <div class="row-fluid">
                                <div class="span6">
                                    <h3>Trees Per Acre</h3>
                                    <input type="text" class="span12" data-bind="value: tpa, valueUpdate: 'keyup'">
                                </div>
                                <div class="span6">
                                    <h3>Stand Age</h3>
                                    <input type="text" class="span12" data-bind="value: age, valueUpdate: 'keyup'">
                                </div>
                            </div>
                            <div class="row-fluid">
                                <div class="btn-group pull-right">
                                    <!--<button class="btn btn-large"><i class="icon-white icon-plus"></i> Cancel</button>-->
                                    <button class="btn btn-large btn-success" data-bind="click: next, enable: name() && tpa() && age()">Next <i class="icon-white icon-arrow-right"></i></button>
                                </div>
                            </div>
                        </div>

                        <div id="myCarousel" class="carousel slide">
                            <div class="carousel-inner" data-bind="foreach: standList">
                                <div class="item">
                                    <h3>Select a Species</h3>
                                    <select name="species" class="span8" data-bind="options: $root.treeSpecies, value: species, select2: { placeholder: 'Select a species'}" class="span12" style="width: 95%"></select>
                                    <div class="row-fluid">
                                        <div class="span6">
                                            <h3>Select a Size Class</h3>
                                            <label class="radio">
                                              <input type="radio" value='1"-5"' data-bind="attr: { name: 'size-class_' + index() }, checked: sizeClass">
                                              1"-5"
                                            </label>
                                            <label class="radio">
                                              <input type="radio" value='5"-10"' data-bind="attr: { name: 'size-class_' + index() }, checked: sizeClass">
                                              5"-10"
                                            </label>
                                            <label class="radio">
                                              <input type="radio" value='10"-15"' data-bind="attr: { name: 'size-class_' + index() }, checked: sizeClass">
                                              10"-15"
                                            </label>
                                        </div>
                                        <div class="span6">
                                            <h3>Percentage of Stand</h3>
                                            <input name="percentage" data-bind="value: percentage, valueUpdate: 'keyup'"/>
                                        </div>
                                    </div>
                                    <div class="row-fluid">
                                        <div class="btn-group pull-right">
                                           <!--<button class="btn btn-large"><i class="icon-white icon-plus"></i> Cancel</button>-->
                                           <button class="btn btn-large" data-bind="click: $parent.prev, enable: index() !== 0"><i class="icon-white icon-arrow-left"></i> Back</button>
                                           <button class="btn btn-large btn-success" data-bind="click: $parent.addSpecies, enable: species() && sizeClass() && percentage()">
                                                
                                                <span data-bind="visible: index() === $parent.standList().length-1"><i class="icon-white icon-plus"></i> Add Species</span>
                                                <span data-bind="visible: index() !== $parent.standList().length-1"><i class="icon-white icon-arrow-right"></i> Update Species</span>
                                            </button>
                                        </div>
                                    </div>         
                                </div>
                            </div>
                            
                        </div>

                            
                        
                    </div>
                </div>
            </div>
          </div>
          <div class="span7">
            <div class="well">
                <div data-bind="if: newStratum()">
                    <h2 data-bind="visible: !newStratum().standList().length">Stand group species have not been defined, yet.</h2>
                        <p>We should have some help text here.</p>
                         <table class="table table-bordered stand-table" data-bind="visible: newStratum().standList().length"  style="display: none">
                             <thead>
                                 <tr><th>Species</th><th>Size Class</th><th>Percentage</th><th>Density (trees per acre)</th></tr>
                             </thead>
                             <tbody data-bind="foreach: newStratum().standList">
                                 <tr data-bind="click: $parent.newStratum().selectRow, css: { active: $data === $parent.newStratum().currentStand() }">
                                     <td>
                                         <span data-bind="visible: species, text: species"></span>
                                         <span data-bind="visible: ! species()">enter a species</span>
                                     </td>
                                     <td>
                                         <span data-bind="visible: sizeClass, text: sizeClass"></span>
                                         <span data-bind="visible: ! sizeClass()">enter a size class</span>
                                     </td>
                                     <td>
                                         <span data-bind="visible: percentage, text: percentage() + '%'"></span>
                                         <span data-bind="visible: ! percentage()">enter a percentage</span>
                                     </td>
                                     <td>
                                         <span data-bind="visible: percentage, text: (percentage()/100*$parent.newStratum().tpa()).toFixed(0)"></span>
                                         <span data-bind="visible: ! percentage()">enter a percentage</span>
                                     </td>
                                 </tr>
                             </tbody>
                             
                         </table>
                         <div class="btn-group pull-right">
                             <button class="btn btn-large" data-bind="click: cancel">cancel</button>
                             <button class="btn btn-large btn-success" data-bind="enable: newStratum().standList().length, click: addStrata"><i class="icon-check icon-white"></i> Done</button>
                         </div>
                         <div class="clearfix"></div>
                    </div>
                <div data-bind="visible: ! newStratum()">
                    <div id="map"></div>
                </div>
            </div>

          </div>
        </div>
        
      <!-- end partial -->

{% endblock content %}
{% block scripts %}
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/jquery.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}common/js/json2.js"></script> <!-- for the benefit of older IEs -->
    <script type="text/javascript" src="{{MEDIA_URL}}common/js/jquery.form.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}common/js/knockout-2.1.0.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}common/js/knockout.mapping-latest.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/knockout-custom-bindings.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/select2.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-tab.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-tooltip.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-carousel.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-button.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-popover.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-modal.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-dropdown.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-transition.js"></script>
    <link class="include" rel="stylesheet" type="text/css" href="{{MEDIA_URL}}jqplot/jquery.jqplot.min.css" />
    <link class="include" rel="stylesheet" type="text/css" href="{{MEDIA_URL}}common/css/jquery-widgets.css" />
    <link class="include" rel="stylesheet" type="text/css" href="{{MEDIA_URL}}support/select2.css" />

    <!--[if lt IE 9]><script language="javascript" type="text/javascript" src="{{MEDIA_URL}}/jqplot/excanvas.js"></script><![endif]-->
    <script class="include" type="text/javascript" src="{{MEDIA_URL}}jqplot/jquery.jqplot.min.js"></script>
    <script class="include" type="text/javascript" src="{{MEDIA_URL}}jqplot/plugins/jqplot.canvasTextRenderer.min.js"></script>
    <script class="include" type="text/javascript" src="{{MEDIA_URL}}jqplot/plugins/jqplot.canvasAxisLabelRenderer.min.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}jqplot/plugins/jqplot.dateAxisRenderer.min.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}jqplot/plugins/jqplot.highlighter.min.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}jqplot/plugins/jqplot.enhancedLegendRenderer.min.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}common/js/chart.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}common/js/jquery-ui.min.js"></script> 
    <script type="text/javascript" src="{{MEDIA_URL}}common/js/jquery.ui.slider.js"></script> 
    <script src="http://maps.google.com/maps/api/js?v=3.5&amp;sensor=false"></script>
    <script src="{{ MEDIA_URL }}OpenLayers.js"></script>
    {% load compressed %}
    <style>
        .stand-table tr.active,
        .table tbody tr:hover td, .table tbody tr:hover th {
            background-color: #E4AF87 !important;
            
        }
        .stand-table tr.active {
            font-weight: bold;
        }
        #map {
            height: 500px;
        }
    </style>
    <script type="text/javascript">
        var madrona = {
            onShow: function (callback) {
                callback();
                //madrona.formCallbacks.push(callback);
            }, 
            formCallbacks: [],
            features: {}
        };

        var app = {
            stands: {},
            scenarios: {},
            properties: {}
        };

        {% if user.is_authenticated %}
        $.get('/features/{{user.username}}/workspace-owner.json', function (data) {
            app.workspace = data;
        });
        {% else %}
        $.get('/features/workspace-public.json', function (data) {
            app.workspace = data;
        });


        

        {% endif %}

        /// to go into strata.js
        app.strata = {
            property_id: "{{ property_id }}",
            treeSpecies: ["Ailanthus", "Alaska cedar", "Apple", "Bigcone Douglas-fir", "Bigleaf maple", "Bishop pine", "Black cottonwood", "Black locust", "Blue oak", "Boxelder", "Brewer spruce", "Bristlecone pine", "California black oak", "California buckeye", "California juniper", "California nutmeg", "California red fir", "California sycamore", "California-laurel", "Canyon live oak", "Cherry", "Coast live oak", "Coulter pine", "Curlleaf mountain-mahogany", "Cypress", "Douglas-fir", "Engelmann spruce", "Englemann oak", "Eucalyptus", "Foxtail pine", "Fremont poplar", "Giant Sequoia", "Golden chinkapin", "Grand fir", "Gray pine", "Holly", "Incense cedar", "Interior live oak", "Jeffrey pine", "Knobcone pine", "Limber pine", "Lodgepole pine", "McNab cypress", "Monterey pine", "Mountain hemlock", "Noble fir", "Oak-unclassified", "Oregon ash", "Oregon white oak", "Pacific dogwood", "Pacific madrone", "Pacific silver fir", "Pacific yew", "Ponderosa pine", "Port-Orford-cedar", "Quaking aspen", "Red alder", "Redwood", "Santa Lucia fir", "Scotch pine", "Shasta red fir", "Singleleaf pinyon", "Sitka spruce", "Subablpine larch", "Subalpine fir", "Sugar pine", "Tanoak", "Unknown hardwood", "Unknown softwood", "Unknown type", "Utah juniper", "Valley (California) white oak", "Walnut", "Water birch", "Western hemlock", "Western juniper", "Western larch", "Western paper birch", "Western redcedar", "Western white pine", "White alder", "White fir", "Whitebark pine", "Willow"]
        };

        app.strata.init = function () {
            app.strata.viewModel = new strataViewModel();
            ko.applyBindings(app.strata.viewModel);
            $('.strata-list').find('li').draggable({
                revert: true
            });

            $( "#map" ).droppable({
              drop: app.strata.viewModel.dropStrata
            });

            // add controls, save references
            app.selectFeature = new OpenLayers.Control.SelectFeature(app.stand_layer,
                { 
                    "clickout": false,
                    "multiple": true

                });
            
            // reenable click and drag in vectors
            app.selectFeature.handlers.feature.stopDown = false; 
            
            map.addControl(app.selectFeature);
            app.selectFeature.activate();
        }

        // individual stand list member
        function speciesViewModel (stratum) {
            var self = this;
            
            // reference to the parent stratum
            self.stratum = stratum;

            // stand characteristics
            self.species = ko.observable();
            self.sizeClass = ko.observable();
            self.percentage = ko.observable();

            self.index = ko.computed(function () {
                var self = this;
                return stratum.standList.indexOf(this);
            }, self);
        };

        // viewmodel for a single stratum
        function stratumViewModel () {
            var self = this;

            self.name = ko.observable();
            self.tpa = ko.observable();
            self.age = ko.observable();
            
            self.standList = ko.observableArray();
            self.currentStand = ko.observable();

            self.addSpecies = function () {
                var stand;
                
                if (self.currentStand().index() === self.standList().length -1) {
                    stand = new speciesViewModel(self);
                    self.standList.push(stand);
                    self.currentStand(stand);

                } else {
                    self.currentStand(self.standList()[self.currentStand().index() + 1]);
                }
                
                $('#myCarousel').carousel('next');

            }

            self.prev = function () {
                var self = this, 
                    stratum = self.stratum;
                
                stratum.currentStand(stratum.standList()[stratum.currentStand().index() - 1]);
                $('#myCarousel').carousel('prev')

            };

            // launch into species list creation
            self.next = function () {
                var self = this,
                    stand = new speciesViewModel(self);
                self.standList.push(stand);
                self.currentStand(stand);
                $('#myCarousel').find('.item:first-child').addClass('active');

            };

       

            self.selectRow = function () {
                var self = this;
                self.stratum.currentStand(self);
                $('#myCarousel').carousel(self.index());
            };

        };

        function strataViewModel () {
          var self = this;

          self.strataList = ko.observableArray([
                {'name': "Test Stand Group 1", uid: "001" },
                {'name': "Test Stand Group 2", uid: "002" },
                {'name': "Test Stand Group 3", uid: "003" }
            ]);

          self.standTotal = app.stand_layer.features.length;

          self.appliedStrataTotal = ko.observable(0);

          // either false, or holds a stratumViewModel
          //self.newStratum = ko.observable(false);
          self.newStratum = ko.observable();

          // the species lists needs an empty string at the beggining
          self.treeSpecies = app.strata.treeSpecies;
          self.treeSpecies.unshift('');

          self.cancel = function () {
            self.newStratum(null);
          }

          self.createStratum = function () {
            self.newStratum(new stratumViewModel());
          };

          self.dropStrata = function( event, ui ) {
                var strataID;
                // get strata id
                strataID = ui.draggable.data('sid');
                
                // apply strata to selected stands
                $.each(app.stand_layer.selectedFeatures, function (i, feature) {
                    // apply strata
                    var currentTotal = self.appliedStrataTotal();
                    self.appliedStrataTotal(currentTotal+1);
                });
                app.selectFeature.unselectAll();
            }

          self.addStrata = function () {
            var self = this,
                stratum = self.newStratum(),
                standList = $.map(stratum.standList(), function (stand) {
                    var sizes = [];
                    if (stand.species() && stand.sizeClass() && stand.percentage()) {
                        sizes = stand.sizeClass().replace(/\"/g, "") .split("-");
                        return [[stand.species(), sizes[0], sizes[1], stand.percentage()]];
                    }
                });

            $.ajax({
                url: "/features/strata/form/",
                type: "POST",
                traditional: true,
                data: {   
                    'name': stratum.name,
                    'search_tpa': stratum.tpa(),
                    'search_age': stratum.age(),
                    'stand_list': ko.toJSON({
                        'classes': standList
                    })
                },
                success: function (response) { 
                    self.strataList.push(self.newStratum());
                    self.newStratum(null);
                },
                error: function (response) { 
                    self.strataList.push(self.newStratum());
                    self.newStratum(null);
                }
            });
          };

        };
    


        $.when(
            $.get("/trees/strata_list/" + app.strata.property_id, function (data) {
                app.strata.data = data;
            }),

            $.get('/trees/list/species.json', function (data) {
                if (data.length) {
                    app.strata.treeSpecies = data;    
                }
                
            }),
            $.get('/features/generic-links/links/geojson/{uid}/'.replace('{uid}', app.strata.property_id), function (data) {
                map.render('map');
                map.updateSize();    
                app.property_layer.addFeatures(app.geojson_format.read(data));
                map.zoomToExtent(app.property_layer.getDataExtent());
                
            }),
            $.get('/features/forestproperty/links/property-stands-geojson/{property_id}/'.replace('{property_id}', app.strata.property_id), function (data) {
                app.stand_layer = new OpenLayers.Layer.Vector("Stands", {
                  styleMap: map_styles.stand,
                  renderers: app.renderer
                });
                map.addLayer(app.stand_layer);
                app.stand_layer.addFeatures(app.geojson_format.read(data));  
            })
        ).then(function () {

            app.strata.init();
        });

        



    </script>
    <script type="text/javascript" src="{{MEDIA_URL}}features/js/workspace.js"></script>
    
    {% compressed_js 'application' %}

    <script src="{{ MEDIA_URL }}common/js/hash_routing.js"></script>
    
    <script src="{{ MEDIA_URL }}common/js/strata.js"></script>

    <!--
    <script src="{{ MEDIA_URL }}common/js/geosearch.js"></script>
    <script src="{{ MEDIA_URL }}common/js/init.js"></script>
    <script src="{{ MEDIA_URL }}common/js/breadcrumbs.js"></script>
    <script src="{{ MEDIA_URL }}common/js/timemap.js"></script>
    -->
{% endblock scripts %}
