{% extends 'common/base.html' %}
{% load url from future %}

{% block content %}

<div class="row-fluid">
	
	<div data-bind="visible: breadcrumbs.length > 0">
		<ul id="breadcrumbs" class="breadcrumb" data-bind="foreach: breadcrumbs">
			<li data-bind="visible: ! $parent.isLast($data)">
				<a data-bind="text: name, click: action"></a>
				<span class="divider">/</span>
			</li>
				<li class="active" data-bind="visible: $parent.isLast($data)">
				<span data-bind="text: name"></span>
			</li>
		</ul>
	</div>

	<header style="display:none" data-bind="visible: $root">

		<div class="btn-group pull-right">
			<a class="btn" data-bind="disable: activeStratum()" href="/#properties"><i class="icon-arrow-left"></i> properties</a>
			<!--<button class="btn btn-mini btn-success" data-bind="disable: activeStratum(), click: createStratum"><i class="icon-plus icon-white"></i> new stand group</button>-->
			<button class="btn btn-success" data-bind="click: createStratum"><i class="icon-plus icon-white"></i> new stand group</button>
		</div>	
		<h1>
			Manage Stand Groups
		</h1>
	</header>

</div>

<div data-bind="if: !activeStratum()">
	<div class="row-fluid">

		<div class="span5">

			<div class="well">

				<!-- strata list -->
				<div class="row-fluid">
					<div class="span12" data-bind="visible: strataList().length && ! activeStratum()" style="display: none" >

						<div class="row-fluid">
								<p>You have applied stand groups to <span data-bind="text: appliedStrataTotal"></span> of <span data-bind="text: standTotal"></span> stands.</p>
								<div class="progress">
									<div class="bar bar-success" data-bind="style: { width: (appliedStrataTotal()/standTotal)*100+'%' }"></div>
								</div>
						</div>

						<div class="row-fluid">
							<div class="form-inline">
									<label for="filter-stand-group">Filter Stand Groups</label>
									<input id="filter-stand-group" type="text" class="search-query" placeholder="Search" data-bind="value: searchTerm, valueUpdate: 'keyup'">
									<button class="btn btn-mini" data-bind="visible: searchTerm, click: clearStandFilter ">Clear Filter</button>
							</div>
						</div>

						<div class="row-fluid strata-list" data-bind="foreach: filteredStrataList()">
							<div class="stratum-box" data-bind="attr: { 'data-color': color(), 'data-sid': attributes.uid }, style: { 'background': color() }, event: { mouseleave: function () { confirmDelete(false) } }">
								<h4><span data-bind="text: attributes.name"></span></h4>
									<div class="row-fluid">
										<div class="span5">
											<dl class="dl-horizontal">
												<dt>Trees Per Acre</dt>
												<dd data-bind="text: attributes.search_tpa"></dd>
												<dt>Stand Age:</dt>
												<dd data-bind="text: attributes.search_age"></dd>
											</dl>
										</div>
										<div class="span7">
											<p><strong>Trees</strong></p>
											<ul class="unstyled tree-list" data-bind="foreach: standList">
												<li data-bind="visible: species">
													<span data-bind="text: sizeClass"></span>
													<span data-bind="text: species"></span>
													(<span data-bind="text: percentage"></span>%)
												</li>
											</ul>

										</div>
									</div>
									<div class="btn-group" data-bind="visible: confirmDelete">
										<button class="btn" data-bind="click: function () { confirmDelete(false) }">cancel</button>
										<button class="btn" data-bind="click: deleteStratum">ok</button>
									</div>
									<div class="btn-group" data-bind="visible: confirmDelete() === false">
										<button class="btn" data-bind="click: $parent.applyStrata">apply</button>
										<button class="btn" data-bind="click: $parent.editStratum"><i class="icon-edit"></i></button>
										<button class="btn" data-bind="click: function () { confirmDelete(true) }"><i class="icon-remove"></i></button>
									</div>
							</div>
						</div>

					</div>
				</div>

				<!-- property has no strata -->
				<div data-bind="visible: !strataList().length && ! activeStratum()" style="display: none">
						You have no stand groups.
				</div>

			</div><!-- /.well -->
		</div>

		<div class="span7">
			<div class="well">
				<div class="map_wrapper">
				 <!--  <button class="btn " data-bind="click: rubberBand, css: { 'btn-inverse': rubberBandActive }">select box</button> -->
					<div id="map"></div>
				</div>
			</div>
		</div>

	</div>
</div><!-- /!activeStratum() -->




<!-- ======================= Edit Stand Group ================== -->

<div class="edit-stand-group" data-bind="if: activeStratum()" >
	<div class="row-fluid">

		<div class="span12">
			<div class="well">

				<div data-bind="visible: activeStratum()" style="display: none">

					<!--
					<div data-bind="visible: !activeStratum().standList().length"  style="display: none">
						<h2>Enter Stand Group Information</h2>
						<p>We should have some help text here.</p>
					</div>
					-->
					
					<div>

						<div data-bind="with: activeStratum" class="row-fluid">
						
							<div class="span6">
								<div>
									<h2 data-bind="visible: !editMode()">Create a New Stand Group</h2>
									<h2 data-bind="visible: editMode()">Editing Stand Group: <i data-bind="text: attributes.name"></i></h2>
									<label>Stand Group Name</label>
									<input type="text" class="span8" placeholder="Stand Group Name" autofocus data-bind="value: attributes.name, valueUpdate: 'keyup'"/>
									<div class="row-fluid">
										<div class="span4">
											<label>Trees Per Acre</label>
											<input type="text" class="input-mini" data-bind="value: attributes.search_tpa, valueUpdate: 'keyup'">
										</div>
										<div class="span4">
											<label>Stand Age</label>
											<input type="text" class="input-mini" data-bind="value: attributes.search_age, valueUpdate: 'keyup'">
										</div>
									</div>
								</div>
							</div> <!-- /.span5 -->

							<div class="span6">
								<div id="chart-container"></div>
							</div>

					 </div> <!-- /.row-fluid /with: activeStratum -->


						<div data-bind="with: activeStratum" class="row-fluid">
						 <table class="table table-bordered stand-table">

							 <thead>
								<tr>
									<th class="species-col">Species</th>
									<th class="size-class-col">Size Class</th>
									<th>Percentage</th>
									<th>Density (trees per acre)</th>
									<th class="actions-col"></th>
								</tr>
							 </thead>

							 <tbody>

								 <!-- ko foreach: displayStandList -->
								 <tr data-bind="visible: !isEditing()">
									 <td>
										 <span data-bind=" text: species"></span>
									 </td>
									 <td>
										 <span data-bind=" text: sizeClass"></span>
									 </td>
									 <td>
										 <span data-bind="text: percentage() + '%'"></span>
									 </td>
									 <td>
										 <span data-bind="text: (percentage()/100*$root.activeStratum().attributes.search_tpa()).toFixed(0)"></span>
									 </td>
									 <td>
										 <div class="btn-group" data-bind="visible: speciesConfirmDelete() === false">
											 <button class="btn btn-mini btn-primary" data-bind="click: editTree">Edit</button>
											 <button class="btn btn-mini" data-bind="click: function () { speciesConfirmDelete(true) } ">Delete</button>
										 </div>
										 <div data-bind="visible: speciesConfirmDelete">
											 <p class="sure">Are you sure?</p>
											 <div class="btn-group">
												 <button class="btn btn-mini" data-bind="click: function () { speciesConfirmDelete(false) } ">Cancel</button>
												 <button class="btn btn-mini btn-success" data-bind="click:  $parent.removeSpecies">Delete</button>
												</div>
										 </div>
									 </td>
								 </tr>
								

								 <tr data-bind="visible: isEditing()">
									 <td>
										 <span>
											 <label class="accessibility">Select a Species <br> <span data-bind="text: species"></span></label>
											 <select style="width: 95%" data-bind="options: app.strata.treeSpecies, value: species,  
												 select2-is-making-me-sad: {  speciesData: species()}" >
											 </select>
										 </span>
									 </td>
									 <td>
										 <span><select data-bind="options: sizeClasses, value: sizeClass"></select></span>
									 </td>
									 <td>
										 <div>
											 <label class="accessibility">Percentage of Stand</label>
											 <input name="percentage" class="input-mini" data-bind="value: percentage, valueUpdate: '$parent.keyup'"/>
											 <div class="help-inline alert-error" data-bind="visible: !$parent.percentageIsValid, text: $parent.percentageIsValidMsg "></div>
										 </div>
									 </td>
									 <td>
										 <span data-bind="text: (percentage()/100*$root.activeStratum().attributes.search_tpa()).toFixed(0)"></span>
									 </td>
									 <td>
										 <span>
											 <button data-bind="click: updateTree" class="btn btn-mini btn-success">Save</button>
										 </span>	
									 </td>
								 </tr>
								 <!-- /ko -->


								 <tr>
									 <td>
										 <label>Select a Species</label>
										 <select name="species" data-bind="options: app.strata.treeSpecies, value: species, select2: {
											 placeholder: 'Select a species',  speciesData: species()}" class="span12" style="width: 95%"></select>
									 </td>
									 <td>
										 <label>Select a Size Class</label>
										 <span><select data-bind="options: sizeClasses, value: sizeClass"></select></span>
										 <!--<pre data-bind="text: 'debugger outside', click: function() {debugger}"></pre>-->
									 </td>
									 <td>
										 <label>Percentage of Stand</label>
										 <input name="percentage" class="input-mini" data-bind="value: percentage, valueUpdate: '$parent.keyup'"/>
										 <div class="help-inline alert-error" data-bind="visible: !$parent.percentageIsValid, text: $parent.percentageIsValidMsg "></div>
									 </td>
									 <td>
										 <!--
										<label>Trees Per Acre</label>
										<input name="tpa" class="input-mini" data-bind="value: tpa, valueUpdate: '$parent.keyup'"/>
										-->
									 </td>
									 <td>
										 <button data-bind="click: addSpecies" class="btn btn-mini btn-success">Save</button>
									 </td>										 
								 </tr>
							 </tbody>

						 </table>
					 </div> <!-- /.row-fluid /with: activeStratum -->

						 <div class="btn-group pull-right">
							 <button class="btn btn-large" data-bind="click: cancel">cancel</button>
							 <button class="btn btn-large btn-success" data-bind="click: saveStrata"><i class="icon-check icon-white"></i> Done</button>
						 </div>
						 <div class="clearfix"></div>

				 </div><!--  -->

			 </div> <!-- / visible: activeStratum -->

		 </div> <!-- /.well -->
	 </div> <!-- /.span12 -->

	</div> <!-- /.row-fluid -->
</div> <!-- /.edit-stand-group -->

<!-- ======================= /End Edit Stand Group ================== -->









                <!--</div> [> /if activeStratum <]-->
        
      <!-- end partial -->

{% endblock content %}
{% block scripts %}
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/jquery.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}common/js/json2.js"></script> <!-- for the benefit of older IEs -->
    <script type="text/javascript" src="{{MEDIA_URL}}common/js/jquery.form.js"></script>
		<script type="text/javascript" src="{{MEDIA_URL}}common/js/knockout-2.1.0.js"></script> 
    <!--<script type="text/javascript" src="{{MEDIA_URL}}common/js/knockout-2.2.1.debug.js"></script>-->
    <script type="text/javascript" src="{{MEDIA_URL}}common/js/knockout.mapping-latest.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/knockout-custom-bindings.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/select2.js"></script>
    
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-tab.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-tooltip.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-carousel.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-button.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-popover.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-modal.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-dropdown.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}support/bootstrap/js/bootstrap-transition.js"></script>
    <script src="http://code.highcharts.com/highcharts.js"></script>

    <!--[if lt IE 9]><script language="javascript" type="text/javascript" src="{{MEDIA_URL}}/jqplot/excanvas.js"></script><![endif]-->
    <script src="http://maps.google.com/maps/api/js?v=3.5&amp;sensor=false"></script>
    <script src="{{ MEDIA_URL }}OpenLayers.js"></script>
    {% load compressed %}
    <style>
      h1 {
        margin-bottom: 10px;
      }

      #chart-container {
        height: 300px;
        width: 100%;
      }
        .stand-table tr.active,
        .table tbody tr:hover td, .table tbody tr:hover th {
          background-color: inherit;            
            
        }

				.stand-table th {
					width: 20%;
				}
					.stand-table .species-col{
						width: 35%;
					}
					.stand-table .size-class-col{
						width: 10%;
					}
					.stand-table .actions-col{
						width: 10%;
					}
        .stand-table tr.active {
            font-weight: bold;
        }
        #map {
            height: 500px;
        }
        .map_wrapper {
          position: relative;
        }
        .map_wrapper .btn {
          position: absolute;
          left: 15px;
          bottom: 15px;
          z-index: 2000;
        }
        
        .strata-list {
          z-index: 2000;
          margin-top: 10px;
          height: 400px;
          overflow-y: auto;

        }
          .strata-list .stratum-box {
            border: 1px solid #aaa;
            padding: 5px 5% 0;
            position: relative;
			      width: 86%;

            /*border-radius: 10px;
            margin: 10px;
            width: 40%;
            /*height: 100px;
            float: left;
            z-index: 2000;*/
            
          }
			  .stratum-box + .stratum-box		{ border-top: none; }
			  .strata-list .stratum-box:hover	{ border: 1px solid #444; }
			  .stratum-box + .stratum-box:hover { margin-top: -1px; }
        .stratum-box .alert-error{
          background-color: #f2f2f2;
          border: 1px solid #DD5240;
          color: #DD5240;
          border-radius: 3px;
          padding: 2px 5px 5px 6px;     
          max-width: 60%;
          text-align: center;
        }
          .strata-list .stratum-box h4 {
			       max-width: 65%;
			       /*
              font-size: 16px;
              margin-left: -5px;
              margin-bottom: 10px;
              text-overflow: ellipsis;
              overflow: hidden;
              white-space: nowrap;
    			  */
          }
		  .strata-list .stratum-box .row-fluid{
			  font-size: 80%;
		  }
          .strata-list .stratum-box p {
            line-height: 5px;
          }
		  .strata-list .stratum-box .dl-horizontal dd, .strata-list .stratum-box .dl-horizontal dt{
				float: left;
				width: auto;
				margin-left: 5px;
		  }
		  .strata-list .stratum-box .dl-horizontal dt{
			  clear: both;
		  }
          .strata-list .stratum-box.ui-draggable-dragging .btn {
            opacity: 0;
          }
          .strata-list .stratum-box .btn-group {
            opacity: 0;
            position: absolute;
            right: 10px;
            top: 10px;
          }
          .strata-list .stratum-box:hover .btn-group {
            opacity: .7;
          }
          .strata-list .stratum-box dl {
            margin-top: -6px;
          }
          .strata-list .stratum-box .tree-list li {
            margin-left: 5px;
          }
          .dl-horizontal dt {
            text-align: left;
          }
          .span6 .alert-error{
            margin-bottom: 10px;
            padding: 5px;
          }   

      .scenario-row dl {
        margin-top: 0px;
      }
		  #filter-stand-group {
			  width: 40%;
		  }
    </style>
    <script type="text/javascript">
        var madrona = {
            onShow: function (callback) {
                callback();
                //madrona.formCallbacks.push(callback);
            }, 
            formCallbacks: [],
            features: {}
        };

        var app = {
            stands: {},
            scenarios: {},
            properties: {}
        };


		

        {% if user.is_authenticated %}
        $.get('/features/{{user.username}}/workspace-owner.json', function (data) {
            app.workspace = data;
        });
        {% else %}
        $.get('/features/workspace-public.json', function (data) {
            app.workspace = data;
        });


        

        {% endif %}

        // to go into strata.js
        app.strata = {
            property_id: "{{ property_id }}",
            color: ['D8E2A7','DA9C90','D2A379','CCC266','ADD071','6AC247','339936','267373','349D7F','449FC1','6A86CD','7971D0','AB81D5','C79FDF','EBC6EC'],
						treeSpecies : ko.observableArray(),
						sizeClasses : []
        };


        app.strata.colorMap = {};
        app.strata.init = function () {
            app.strata.viewModel = new strataViewModel();

            $.each(app.strata.data, function (i, strata) {
              app.strata.viewModel.strataList.push(new stratumViewModel(strata));
            });

            // app.breadCrumbs.breadcrumbs.push({url: 'stands/', action: null});
            // app.updateUrl();
   
            ko.applyBindings(app.strata.viewModel);

            // $( "#map" ).droppable({
            //   drop: function (event, ui) {
            //       app.strata.viewModel.applyStrata(ui.draggable.data('sid'))  
            //     }
            // });

            // add controls, save references
            app.selectFeature = new OpenLayers.Control.SelectFeature(app.stand_layer,
                { 
                    "clickout": false,
                    "multiple": true,
                    "toggle": true,
										//styling here to ensure selecting stands with strata applied appear selected.
										"selectStyle": map_styles.strataSelect      //defined in styles.js

                });

							map.render('map');
							map.updateSize();    
							map.zoomToExtent(app.property_layer.getDataExtent());

		

            // reenable click and drag in vectors
            map.addControl(app.selectFeature); 
            app.selectFeature.activate();

        }








        // individual stand list member
        function standViewModel (stratum, options) {
            var self = this, chartTimer = null;
            if (! options) {
              options = []
            }
            // reference to the parent stratum
            self.stratum = stratum;

            // stand characteristics
            self.species = ko.observable(options[0]);

            if (options[1] && options[2]) {
              self.sizeClass = ko.observable([options[1] + '"', options[2] + '"'].join(' to '));  
            } else {
              self.sizeClass = ko.observable();
            }

            if (options[3]) {
              self.percentage = ko.observable(parseInt(options[3], 10));  
            } else {
              self.percentage = ko.observable();
            }
            
            self.percentageIsValid = ko.observable(true);
            self.percentageIsValidMsg = ko.observable('');
            
            self.index = ko.computed(function () {
                var self = this;
                return stratum.standList.indexOf(this);
            }, self);

            self.updateChart = function () {
              // delay the chart update for a bit
              if (chartTimer) {
                clearTimeout(chartTimer);
              } 
              chartTimer = setTimeout(function () {
                app.strata.chartStandList(self.stratum.displayStandList());    
              }, 500);
            
              
            };

						self.isEditing = ko.observable(false);
						self.speciesConfirmDelete = ko.observable(false);

            self.editTree = function (event) {
                this.isEditing(true);
            }

            self.updateTree = function (task) {
                this.isEditing(false);
            }

						self.sizeClasses = ko.computed(function() {
								var pos = app.strata.treeSpecies().indexOf(self.species());
								return app.strata.sizeClasses[pos-1];
						}, self);

            self.percentage.subscribe(self.updateChart);
            self.species.subscribe(self.updateChart);
            self.sizeClass.subscribe(self.updateChart);

            return self;
        };








        // viewmodel for a single stratum
        function stratumViewModel (options) {
            var self = {};

            if (! options) {
              options = {}
            }
            self.attributes = {
              // feature attributes from madrona
              name: ko.observable(options.name),
              search_tpa: ko.observable(options.search_tpa),
              search_age: ko.observable(options.search_age),
              additional_desc: ko.observable(options.additional_desc),
              stand_list: ko.observable(options.stand_list),
              uid: options.uid
            }
            
            // viewmodel attributes
            self.color = ko.observable();
            self.currentStand = ko.observable();
            self.confirmDelete = ko.observable(false);
            self.editMode = ko.observable(false);
            self.editTrees = ko.observable(false); 

            self.species = ko.observable(); 
            self.sizeClass = ko.observable(); 
            self.sizeLow = ko.observable(); 
            self.sizeHigh = ko.observable(); 

            self.percentage = ko.observable(); 
            self.tpa = ko.observable(); 

            self.standList = ko.observableArray();
            // display a computed standlist with a dummy last item
            // to show the remaining percentage
            self.displayStandList = ko.computed(function () {
              var displayStandList = [], totalPercentage = 0, msg;

              $.each(self.standList(), function (i, stand) {
                if (stand.percentage()) {
                  totalPercentage += parseInt(stand.percentage(), 10);

                  // no no
                  if (totalPercentage > 100) {
                    msg = "You've entered a percentage over 100 (" + totalPercentage +") for this stand group. Please enter a percentage of ";
                    msg += 100 - (totalPercentage-stand.percentage() ) + " or less for this species."

                    stand.percentageIsValid(false);                   
                    stand.percentageIsValidMsg(msg);

                    return;

                  }
                }
                stand.percentageIsValid(true);                   
								displayStandList.push(stand);  
              });

							/*
							// @TODO fix this. causing more trouble than it's worth at the moment.
							// without it, the chart does not render properly if species do not add up to 100%
              if (totalPercentage < 100 && totalPercentage != 0) { // == 0 on load

								var placeHolder = new standViewModel(self,
                  // species name, sizeclass lower bound, upper bound, percentage
                  [ 'Unknown type', "?", "?", 100 - totalPercentage ]) 

								displayStandList.push(placeHolder);
								self.standList.push(placeHolder);
								//self.currentStand(placeHolder);
								//self.currentStand().updateChart();
									

									/*
                displayStandList.push(new standViewModel(self,
                  // species name, sizeclass lower bound, upper bound, percentage
                  [ 'Unknown type', "?", "?", 100 - totalPercentage ]));
									
									
              }
							*/

              return displayStandList;
            });


            if (options.stand_list) {
              $.each(options.stand_list.classes || JSON.parse(options.stand_list).classes, function (i, stand) {
                self.standList.push(new standViewModel(self, stand));
              });
            }

						// set the color and store a reference
						if (self.attributes.uid != undefined && app.strata.colorMap[self.attributes.uid]) {
              self.color(app.strata.colorMap[self.attributes.uid]);
            } else {
              self.color('#' + app.strata.color.reverse().pop());
							app.strata.colorMap[self.attributes.uid] = self.color();      //TODO: app.strata.colorMap['undefined'] is being set. This should probably be fixed
            }

						// initial stand coloring
						$.each(app.stand_layer.features, function (i, stand) {
							// @TODO: if you have 10 strata and 15 stands, this is running 150 times.
							// better way?
							if ( stand.attributes.strata !== null && stand.attributes.strata.uid === self.attributes.uid ) {
								stand.style = { fillColor: self.color(), fillOpacity: '.6', strokeColor: '#fff' };
								app.stand_layer.drawFeature(stand);
								app.strata.viewModel.setAppliedStrataTotal();
							}
						});

            self.deleteStratum = function (stratum) {
              app.strata.deleteStratum(stratum.attributes.uid, function () {
                app.strata.viewModel.strataList.remove(stratum);
								self.clearStands(stratum.attributes.uid);
							});
            };


						//when a stratum is deleted, make sure we clear the existing stands on the map as well
						self.clearStands = function(uid){
							$.each(app.stand_layer.features, function (i, feature) {
								// is it a stand assigned to the deleted stratum?
								if ( feature.attributes.strata !== null && feature.attributes.strata.uid === uid ) {
									//clear and apply
									feature.style = { fillColor: 'Transparent', fillOpacity: '.6', strokeColor: '#fff' };
									feature.attributes.strata = null;
									feature.data.strata = null;
									app.stand_layer.drawFeature(feature);

									//hey count, pay attention.
									app.strata.viewModel.setAppliedStrataTotal();
								}
							});	
						};

						/*
            // launch into species list creation
            self.next = function () {
							//unused 6/3 -wm
                var self = this,
                    stand = new standViewModel(self);

                if ( !self.editMode() ) {
                  self.standList.push(stand);
                  self.currentStand(stand);
                } else {
                  self.currentStand(self.standList()[self.standList().length-1]);
                  self.editTrees(true);
                }
            };

            self.prev = function () {
							//unused 6/3 -wm
                var self = this, 
                    stratum = self.stratum;
                
                stratum.currentStand(stratum.standList()[stratum.currentStand().index() - 1]);
            };

						self.saveSpecies = function () {
							if ( !self.editMode() ) {
								self.standList.push(stand);
								self.currentStand(stand);
							} else {
								self.currentStand(self.standList()[self.standList().length-1]);
								//self.editTrees(true);
							}
							self.currentStand().editTrees(false)
							self.editTrees(false);
						};


						self.editSpecies = function(){
							var self = this.stratum,
									stand = new standViewModel(self);

							self.currentStand(self.standList()[self.standList().length-1]);
						}
						self.selectRow = function () {
							//unused 6/2
							var self = this;
							if (self.stratum.currentStand().species !== 'unknown') {
								self.stratum.currentStand(self);
							}
						};

						*/

						self.addSpecies = function (stand, event) {
							var stand,
									self = this,
									attrs = [],
									sizes;

							//sizes = '24" to 36"' - remove quotes and split
							sizes = self.sizeClass().replace(/(")/g, "").split(" to ");

							// 139% sure there is a better way. 
							attrs[0] = self.species();
							attrs[1] = sizes[0];
							attrs[2] = sizes[1];
							attrs[3] = self.percentage();

							stand = new standViewModel(self, attrs);

							self.species('');
							self.percentage('');

							self.standList.push(stand);
							self.currentStand(stand);
							self.currentStand().updateChart();
						};

						self.removeSpecies = function(stand){
							self.standList.remove(stand);
						};





						self.sizeClasses = ko.computed(function() {
								var pos = app.strata.treeSpecies().indexOf(self.species());
								return app.strata.sizeClasses[pos-1];
						}, self);

						ko.bindingHandlers.select2 = {
							init: function(element, valueAccessor, allBindingsAccessor) {
								var obj = valueAccessor(),
										allBindings = allBindingsAccessor(),
										lookupKey = allBindings.lookupKey;

								$(element).select2(obj);

								if (lookupKey) {
									var value = ko.utils.unwrapObservable(allBindings.value);
									$(element).select2('data', ko.utils.arrayFirst(obj.data.results, function(item) {
										return item[lookupKey] === value;
									}));
								}
								// $(element).select2(valueAccessor());
								// console.log('select2 valueAccessor', valueAccessor() );

								ko.utils.domNodeDisposal.addDisposeCallback(element, function() {
									$(element).select2('destroy');
								});
							},
							update: function(element, valueAccessor, allBindingsAccessor, viewModel, bindingContext) {
								//$(element).trigger('change');
								
                if ( !self.currentStand() ) {
									var stand = new standViewModel(self);
                  self.currentStand(stand);
								}

								
							}
						};



            return self;
        };








        function strataViewModel () {
          var self = {};

          // filter term for strata
          self.searchTerm = ko.observable();
          // list of strata
          self.strataList = ko.observableArray();

          self.standTotal = app.stand_layer.features.length;

					// n of Y stands applied
          self.appliedStrataTotal = ko.observable(0);
          self.setAppliedStrataTotal = function(){
          	 var total = 0;

          	$.each(app.stand_layer.features, function (i, stand) {
							if (stand.attributes.strata !== null ) {
								total = total + 1;
							}	
						});
						self.appliedStrataTotal(total);

          };


          // either false, or holds a stratumViewModel
          self.activeStratum = ko.observable();

          // the species lists needs an empty string at the beggining
          self.treeSpecies = app.strata.treeSpecies;
          self.treeSpecies.unshift('');

          // strata list that is actually displayed on the page
          // filtered by searchTerm
          self.filteredStrataList = ko.computed(function () {
            var strataList = this, filteredStrataList = [],
              searchTerm;
            
            if (self.searchTerm()) {
              searchTerm = self.searchTerm().toLowerCase();
					
              // filter the strata list
              $.each(strataList(), function (i, strata) {

                // if (strata.attributes.name().toLowerCase().indexOf(searchTerm) !== -1 || strata.attributes.stand_list().toLowerCase().indexOf(searchTerm) !== -1) {
                if (strata.attributes.name().toLowerCase().indexOf(searchTerm) !== -1) {
                  filteredStrataList.push(strata);
                } 
              });
            } else {
              filteredStrataList = strataList();
            }
            return filteredStrataList;
          }, self.strataList);

					self.clearStandFilter = function(){
						self.searchTerm("");
					}

          self.activeStratum.subscribe(function (activeStratum) {

            if (activeStratum && activeStratum.standList().length) {
              app.strata.chartStandList(activeStratum.displayStandList());  
            } else { // no active stratum, so set cached chart data to null
              app.strata.chartData = null;
            }
            
          });

          self.strataList.subscribe(function(){
          	self.setAppliedStrataTotal();
          });
          
          self.rubberBandActive = ko.observable(false);

          app.selectFeature = new OpenLayers.Control.SelectFeature(app.stand_layer,
            { 
              "clickout": false,
              "multiple": true,
              "toggle": true,
              "selectStyle": map_styles.strataSelect
            });
            
          app.selectFeatureBox = new OpenLayers.Control.SelectFeature(app.stand_layer,
            { 
              "clickout": false,
              "multiple": true,
              "toggle": true,
              "box": true,
              "selectStyle": map_styles.strataShiftSelect
            }); 
          
          $(document).on('keydown', function (e) {
            if (e.shiftKey && !self.rubberBandActive()) {
              self.rubberBandActive(true);
              app.selectFeature.deactivate();
              app.selectFeatureBox.activate();
            }
          });
          
          $(document).on('keyup', function (e) {
              if (self.rubberBandActive()) {
                self.rubberBandActive(false);
                app.selectFeatureBox.deactivate();
                app.selectFeature.activate();
              }
          });
          
          map.addControl(app.selectFeature); 
          map.addControl(app.selectFeatureBox); 

          self.editStratum = function (stratum) {
            var duplicateStratum = new stratumViewModel(ko.toJS(stratum.attributes));
            app.strata.stratumBeingEdited = stratum;
            duplicateStratum.editMode(true);
            self.activeStratum(duplicateStratum);
          };

          self.cancel = function () {
            self.activeStratum(null);
            map.render('map'); //@TODO not sure why this is needed.
          }

          self.createStratum = function () {
            self.activeStratum(new stratumViewModel());
          };

          self.applyStrata = function( stratum ) {
            // can be called from the draggable/droppable
            // switching to the knockout binding
            // for now
            var stand_uid_list = [],
                color = stratum.color(),
                stratum_id = stratum.attributes.uid;

						// get strata id, if knockout stratum will be this

						// Do we have a strata selected?
						// @TODO more KO, less JQ
						if( !app.stand_layer.selectedFeatures.length ){

							var msg = "Please select an area on your map to apply this stand group.",
								$t;

							// little clean up because DOM stuff is silly
							$('.stratum-box .alert-error').remove();

							// add and remove a temporary warning
							$('[data-sid="'+stratum_id+'"]').prepend('<div class="alert-error">'+msg+'</div>')
							.find('.alert-error').each(function(){ 
								$t = $(this);
								window.setTimeout(function(){
								$t.fadeOut(1300, function(){
									$t.remove();
								}); 
								}, 5000);
							});

							return;
						}
						
						// apply strata to selected stands
						$.each(app.stand_layer.selectedFeatures, function (i, feature) {
							// don't count features already counted 
							if (!feature.attributes.strata){
								// var currentTotal = self.appliedStrataTotal();
								// self.appliedStrataTotal(currentTotal+1);
							}
							feature.style = { fillColor: color, fillOpacity: '.6', strokeColor: '#fff' };
							feature.attributes.strata = ko.mapping.toJS(stratum.attributes);
							feature.data.strata = ko.mapping.toJS(stratum.attributes);

							app.stand_layer.drawFeature(feature);
							stand_uid_list.push(feature.attributes.uid);
						});

						app.strata.applyStrataToStand(stratum_id, stand_uid_list);
						app.selectFeature.unselectAll();
						self.setAppliedStrataTotal();
          }

          self.updateStratum = function (oldStratum, activeStratum) {
            self.strataList.replace(oldStratum, new stratumViewModel(activeStratum));
          };


					self.saveStrata = function () {
            var self = this, postData,
                stratum = self.activeStratum(),
                //stratum = app.strata.viewModel.activeStratum(),
                url = "/features/strata/form/";

            if (stratum.editMode()) {
              url = "/features/strata/{uid}/".replace('{uid}', stratum.attributes.uid);
            }
            
            postData = ko.mapping.toJS(stratum.attributes);

            postData.stand_list = ko.toJSON({
              'property': app.strata.property_id,
              'classes': $.map(stratum.standList(), function (stand) {
                    var sizes = [];

                    if (stand.species() && stand.sizeClass() && stand.percentage()) {
                        //sizes = stand.sizeClass().replace(/\"/g, "") .split("-");
												sizes = stand.sizeClass().replace(/(")/g, "").split(" to ");
												
                        return [[
                          stand.species(), 
                          parseInt(sizes[0], 10), 
                          parseInt(sizes[1], 10), 
                          parseInt(stand.percentage(), 10)
                        ]];
                    }
                })
            });

            $.ajax({
                url: url,
                type: "POST",
                traditional: true,
                dataType: 'json',
                data: postData,
                success: function (response) { 

                    var strata_uid = response["X-Madrona-Select"];
                    if (stratum.editMode()) {
                      // existing strata
                      self.updateStratum(app.strata.stratumBeingEdited, postData);
                    } else {
                      // new strata
                      app.strata.associateStandWithProperty(app.strata.property_uid, strata_uid);
                      self.activeStratum().attributes.stand_list = postData.stand_list;
                      self.activeStratum().attributes.uid = strata_uid;
                      self.strataList.push(self.activeStratum());  
                    }
                    
                    self.activeStratum(null);
										// @TODO not yet sure why this is needed. Map was hidden in OG Stand UI via the same KO mechanism (!activeStratum)
										map.render('map');
                    
                },
                error: function (response) { 
                    self.strataList.push(self.activeStratum());
                    self.activeStratum(null);
										map.render('map');
                }

            });
          };

          return self;
        };
    


        app.strata.deleteStratum = function (strata_uid, cb) {
          var url = "/features/generic-links/links/delete/{strata_uid}/".replace('{strata_uid}', strata_uid);
          
          return $.ajax({
              url: url,
              type: "DELETE",
              traditional: true,
              success: function (response) { 
                cb();
              },
              error: function (response) { 
                //debugger;
              }
          });
        };

        app.strata.applyStrataToStand = function (strata_uid, stand_uid_list) {
          var url = "/features/strata/links/add-stands/{strata_uid}/".replace('{strata_uid}', strata_uid);
          
          return $.ajax({
              url: url,
              type: "POST",
              data: { 'stands': stand_uid_list.join() },
              traditional: true,
              success: function (response) { 
                //debugger;
              },
              error: function (response) { 
                //debugger;
              }
          });
        };

        app.strata.associateStandWithProperty = function (property_uid, strata_uid) {
          var url = "/features/forestproperty/{property_uid}/add/{strata_uid}";
          
          url = url.replace('{property_uid}', app.strata.property_id);
          url = url.replace('{strata_uid}', strata_uid);

          return $.ajax({
              url: url,
              type: "POST",
              traditional: true,
              success: function (response) { 
                  
              },
              error: function (response) { 
                  
              }
          });
        }


        $.when(
            $.getJSON("/features/forestproperty/links/property-strata-list/" + app.strata.property_id + '/', function (data) {
                app.strata.data = data;
            }),

						//get the actual available species
            $.getJSON("/trees/variant/" + app.strata.property_id + "/species_sizecls.json", function (data) {
							//should probably be done server side.
							data.sort(function(a,b) {
								if(a.species<b.species) return -1;
								if(a.species>b.species) return 1;
								return 0;
							});
							$.each(data, function(i,tree){
								var	sizes = $.map(tree.size_classes, function(a,i){
									//return [[a.min, a.max]];
									return a.min.toString() + '" to ' + a.max.toString() +'"';
								});
								app.strata.treeSpecies.push(tree.species);
								app.strata.sizeClasses.push(sizes);
							});
            }),

            $.get('/features/generic-links/links/geojson/{uid}/'.replace('{uid}', app.strata.property_id), function (data) {
                app.property_layer.addFeatures(app.geojson_format.read(data));
                
            }),
            $.get('/features/forestproperty/links/property-stands-geojson/{property_id}/'.replace('{property_id}', app.strata.property_id), function (data) {
                //var styleMap = map_styles.stand;
                app.stand_layer = new OpenLayers.Layer.Vector("Stands", {
                  styleMap: map_styles.stand,
                  renderers: app.renderer
                });

                app.stand_layer.styleMap.default = new OpenLayers.Style({
                  fillColor: "blue",
                }, {
                  // Rules go here.
                  context: {
                  }
                });
                map.addLayer(app.stand_layer);
                app.stand_layer.addFeatures(app.geojson_format.read(data));  
            })
        ).then(function () {
            app.strata.init();
        });

      // charting stuff
      app.strata.chartData = null;
      app.strata.chartTimer = null;

      app.strata.chartStandList = function (standList) {
        var chart, chartData, chartDataUpdated = true;
        if (app.strata.chartTimer) {

        }  
        chartData = $.map(standList, function (stand) {
          var sizeClass = stand.sizeClass() ? (' ' + stand.sizeClass()): null;
          if (stand.percentage()) {
            return [
              [ 
                stand.species() +  ' ' + sizeClass,
                parseInt(stand.percentage(),10)
              ]
            ];
          }
        });
        // check to see if data has been udpated
        if (app.strata.chartData && ko.toJSON(chartData) === ko.toJSON(app.strata.chartData)) {
          chartDataUpdated = false;
        }
        if (chartDataUpdated) {
          setTimeout(function () {
            app.strata.chartData = chartData;
            chart = new Highcharts.Chart({
                chart: {
                    renderTo: 'chart-container',
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false,
                    backgroundColor:'rgba(255, 255, 255, 0.1)'
                },
                title: false,
                credits: false,
                tooltip: {
                  pointFormat: '{series.name}: <b>{point.percentage}%</b>',
                  percentageDecimals: 1
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: false,
                            color: '#000000',
                            connectorColor: '#000000',
                            formatter: function() {
                                return '<b>'+ this.point.name +'</b>: '+ this.percentage +' %';
                            }
                        }
                    }
                },
                series: [{
                    type: 'pie',
                    name: 'Percentage',
                    data: chartData
                }]
            
            });  
          }, 300); 
        }
      };


    </script>
    <script type="text/javascript" src="{{MEDIA_URL}}features/js/workspace.js"></script>
    
    {% compressed_js 'application' %}

    <script src="{{ MEDIA_URL }}common/js/hash_routing.js"></script>
        

    <script src="{{ MEDIA_URL }}common/js/strata.js"></script>

    <!--
    <script src="{{ MEDIA_URL }}common/js/geosearch.js"></script>
    <script src="{{ MEDIA_URL }}common/js/init.js"></script>
    <script src="{{ MEDIA_URL }}common/js/timemap.js"></script>
    -->
    <script src="{{ MEDIA_URL }}common/js/breadcrumbs.js"></script>
{% endblock scripts %}



