{% extends 'common/base.html' %}

{% block content %}
   <!-- this should go into a partial -->
      <div class="row-fluid">
        <div class="span4">
          <div><h1>Manage Properties</h1></div>
        </div>
        <div class="span8">
          <span class="pull-right">
            <form class="form-search">
              <input type="text" class="input-large search-query" placeholder="placename or parcel id">
              <button class="btn" type="submit">Search</button>
            </form>
          </span>
        </div>
      </div>
        <div class="row-fluid">
          <div class="span3">
            <ul class="breadcrumb">
              <li>
                <a href="#">Home</a> <span class="divider">/</span>
              </li>
              <li class="active">Properties</li>
            </ul>
            <div class="well"> <!-- need to make this a different color -->
              <h2>Property List</h2>
              <div id="properties-none" style="display:none" data-bind="visible: ! hasProperties">
                <p>Find your properties on the map by searching for a placename or parcel id.</p>
                <div>
                    <form class="form-search">
                        <input type="text" class="input-large search-query" placeholder="placename or parcel id">
                        <button class="btn" type="submit">Search</button>
                    </form>
                </div>
                <h3>Draw your property</h3>
                <p>When your property is in view on the map, click the button below to draw the boundaries of your first property.</p>
                <h3>Add additional information</h3>
                <p>Then you will be asked to enter some additional information to help describe your property.</p>
                <div class="pull-right">
                  <button href="#" class="btn btn-large btn-primary">Draw Property</button>
                </div>
              </div> <!-- no properties -->
              <div id="properties-list" style="display:none" data-bind="visible: hasProperties">
                <p><button href="#" class="btn" data-bind="click: showAddForm">Add Property</button><p>
                <div class="row-fluid">
                  <table class="table table-condensed table-bordered">
                    <thead><th>Name</th><th>Area (acres)</th><th>County</th></thead>
                    <tbody data-bind="foreach: propertyList">
                      <tr data-bind="click: $parent.selectProperty">
                        <td><a data-bind="text: name"></a></td>
                        <td>7</td>
                        <td>Multnomah</td>           
                      </tr>
                    </tbody>
                  </table>
                  <div class="pull-right">
                    <button class="btn btn-primary" href="#" data-bind="click: showEditForm">Edit Property</button>
                  </div>
                </div>
                <div class="row-fluid">
                  <h2>Property Details</h2>
                  <table class="table">
                    <tr><td>Name</td><td><span data-bind="text: selectedProperty().name"><span></td></tr>
                    <tr><td>Area</td><td>7 acres</td></tr>
                    <tr><td>County</td><td>Multnomah</td></tr>
                  </table>
                  <div class="pull-right">
                    <button class="btn" href="#">Perform Analysis</button>
                    <button class="btn" href="#">Add Stands</button>
                  </div>
                </div>
              </div><!-- has properties -->
            </div>
          </div>
          <div class="span9">
            <div class="outermap">
              <div id="map"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- end partial -->
    

    <script type="text/javascript">

    $.get('/features/{{user.username}}/workspace-owner.json', function (data) {
      console.dir(data);
    });

    function propertiesViewModel() {
      var self = this;
      // TODO: make function to map properties with test  
      self.propertyList = ko.observableArray();

      self.hasProperties = function () { return self.propertyList().length > 0 };


      self.selectProperty = function (property, event) {
        // TODO: Make active!
        $(event.target).closest('tr')
          .addClass('active')
          .siblings().removeClass('active');
        
        self.selectedProperty(property);
      };

      self.showEditForm = function () {
        var formUrl = 'features/forestproperty/{uid}/form/'.replace('{uid}', this.selectedProperty().uid());
        $.get(formUrl, function (data) {
          var $form = $(data).find('form');
          
          // remove the submit button, strip out the geometry
          $form
            .find('input:submit').remove().end()
            .find('#id_geometry_final').closest('.field').remove();

          // put the form in a well and focus the first field
          $form.addClass('well');
          $form.find('input:visible').first().focus();
          
          // show the form in a modal
          $('#modal').modal('show')
            .find('.modal-body').empty().append($form).end()
            .find('.modal-header').find('h3').text('Edit Property');
        })
      };

      self.showAddForm = function () {
        var formUrl = 'features/forestproperty/form/';

        self.selectedProperty({
          "name": ko.observable(""),
          "area": 4,
          "county": "Multnomah"
        });
        $.get(formUrl, function (data) {
          var $form = $(data).find('form');
          
          // remove the submit button, strip out the geometry
          $form
            .find('input:submit').remove().end()
            .find('#id_geometry_final').closest('.field').remove();

          // put the form in a well and focus the first field
          $form.addClass('well');
          $form.find('input:visible').first().focus();
          
          // show the form in a modal
          $('#modal').modal('show')
            .find('.modal-body').empty().append($form).end()
            .find('.modal-header').find('h3').text('Add Property');
        })
      };

      self.saveEditForm = function () {
        var $form = $('#modal').find('form'), 
          actionUrl = $form.attr('action'),
          values = {};

        $form.find('input').each(function () {
          var $input = $(this);
          values[$input.attr('name')] = $input.val();
        });

        $('#modal').modal('hide');
        $.ajax({
          url: actionUrl,
          type: "POST",
          data: values,
          success: function (data, textStatus, jqXHR) {
            self.updateOrCreateProperty(JSON.parse(data), self.selectedProperty())
          }
        });
      };

      self.updateOrCreateProperty = function (data, property) {
        var updateUrl = 'features/generic-links/links/geojson/{uid}/'.replace('{uid}', data["X-Madrona-Select"]);
        $.get(updateUrl, function (data) {
          var newProperty = data.features[0].properties;
          if (property.uid) {
            // updating existing property
            ko.mapping.fromJS(newProperty, property);
          } else {
            self.propertyList.unshift(ko.mapping.fromJS(newProperty));
          }
        });
      };

      self.cancelEditForm = function () {
        $('#modal').modal('hide');
      };

      // initialize properties and vm
      self.loadProperties = function () {
        $.get('/trees/user_property_list/', function (data) {
          
          self.propertyList = ko.observableArray($.map(data.features, function (feature, i) {
            return ko.mapping.fromJS(feature.properties);
          }));
          
          self.selectedProperty = ko.observable(self.propertyList()[0]);
          ko.applyBindings(self);

        });  
      }
      
    };

    window.viewModel = new propertiesViewModel();
    viewModel.loadProperties();

    $(document).ready(function () {
      var onResize = function () {
        $("#map").height($(window).height() * .75);
      };

      //$('#modal').modal({'show': false});
      
      onResize();
      $(window).resize(onResize);
      
    });

    </script>
{% endblock content %}
{% block scripts %}
    <script src="http://maps.google.com/maps/api/js?v=3.5&amp;sensor=false"></script>
    <script src="/media/OpenLayers.js"></script>
    {% load compressed %}
    {% compressed_js 'application' %}
{% endblock scripts %}
