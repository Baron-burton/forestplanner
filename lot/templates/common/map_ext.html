{% extends 'common/base.html' %}

{% block content %}
   <!-- this should go into a partial -->
      <div class="row-fluid">
        <div class="span4">
          <div><h1>Manage Properties</h1></div>
        </div>
        <div class="span8">
          <span class="pull-right">
            <form class="form-search">
              <input type="text" class="input-large search-query" placeholder="placename or parcel id">
              <button class="btn" type="submit">Search</button>
            </form>
          </span>
        </div>
      </div>
        <div class="row-fluid">
          <div class="span3">
            <ul class="breadcrumb">
              <li>
                <a href="#">Home</a> <span class="divider">/</span>
              </li>
              <li class="active">Properties</li>
            </ul>
            <div class="well"> <!-- need to make this a different color -->
              <h2>Property List</h2>
              <div id="properties-none" style="display:none" data-bind="visible: ! hasProperties">
                <p>Find your properties on the map by searching for a placename or parcel id.</p>
                <div>
                    <form class="form-search">
                        <input type="text" class="input-large search-query" placeholder="placename or parcel id">
                        <button class="btn" type="submit">Search</button>
                    </form>
                </div>
                <h3>Draw your property</h3>
                <p>When your property is in view on the map, click the button below to draw the boundaries of your first property.</p>
                <h3>Add additional information</h3>
                <p>Then you will be asked to enter some additional information to help describe your property.</p>
                <div class="pull-right">
                  <button href="#" class="btn btn-large btn-primary">Draw Property</button>
                </div>
              </div> <!-- no properties -->
              <div id="properties-list" style="display:none" data-bind="visible: hasProperties">
                <div class="row-fluid">
                  <table class="table table-condensed table-bordered table-striped">
                    <thead><th>Name</th><th>Area (acres)</th><th>County</th></thead>
                    <tbody data-bind="foreach: propertyList">
                      <tr data-bind="click: $parent.selectProperty">
                        <td><a data-bind="text: name"></a></td>
                        <td data-bind="text: area"></td>
                        <td data-bind="text: county"></td>           
                      </tr>
                    </tbody>
                  </table>
                  <div class="pull-right">
                    <button href="#" class="pull-right btn btn-primary" data-bind="click: showAddForm">Add Property</button>
                  </div>
                </div>
                <div class="row-fluid">
                  <h2>Property Details</h2>
                  <table class="table">
                    <tr><td>Name</td><td><span data-bind="text: selectedProperty().name"><span></td></tr>
                    <tr><td>Area</td><td><span data-bind="text: selectedProperty().area"></span> acres</td></tr>
                    <tr><td>County</td><td><span data-bind="text: selectedProperty().county"></span></td></tr>
                  </table>
                  <div class="pull-right">
                    <button class="btn" href="#">Perform Analysis</button>
                    <button class="btn" href="#">Add Stands</button>
                    <button class="btn" href="#" data-bind="click: showEditForm">Edit Property</button>
                  </div>
                </div>
              </div><!-- has properties -->
            </div>
          </div>
          <div class="span9">
            <div class="outermap">
              <div id="map"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- end partial -->
    

    <script type="text/javascript">

    var properties = {
      "type": "FeatureCollection",
      "features": [{
        "type": "Feature",
        "geometry": {
          "type": "Polygon",
          "coordinates": [
            [
              [-13405093.081326, 4078592.850650],
              [-13318263.878507, 4071851.570255],
              [-13317150.683599, 4044926.498167],
              [-13407319.471142, 4048961.188709],
              [-13405093.081326, 4078592.850650]
            ]
          ]
        },
        "properties": {
          "user_id": 1,
          "uid": "trees_forestproperty_1",
          "date_modified": "2012-03-20 09:35:49.036457",
          "bbox": [-13407319.471141858, 4044926.4981666785, -13317150.683599308, 4078592.8506504213],
          "date_created": "2012-03-20 09:35:49.036377",
          "name": "Deep Forest Site",
          "area": 39,
          "county": "Marion"
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Polygon",
          "coordinates": [
            [
              [-13405093.081326, 4078592.850650],
              [-13318263.878507, 4071851.570255],
              [-13317150.683599, 4044926.498167],
              [-13407319.471142, 4048961.188709],
              [-13405093.081326, 4078592.850650]
            ]
          ]
        },
        "properties": {
          "user_id": 1,
          "uid": "trees_forestproperty_2",
          "date_modified": "2012-03-20 09:35:49.036457",
          "bbox": [-13407319.471141858, 4044926.4981666785, -13317150.683599308, 4078592.8506504213],
          "date_created": "2012-03-20 09:35:49.036377",
          "name": "The Other Property",
          "area": 27,
          "county": "Tillamook"
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Polygon",
          "coordinates": [
            [
              [-13405093.081326, 4078592.850650],
              [-13318263.878507, 4071851.570255],
              [-13317150.683599, 4044926.498167],
              [-13407319.471142, 4048961.188709],
              [-13405093.081326, 4078592.850650]
            ]
          ]
        },
        "properties": {
          "user_id": 1,
          "uid": "trees_forestproperty_3",
          "date_modified": "2012-03-20 09:35:49.036457",
          "bbox": [-13407319.471141858, 4044926.4981666785, -13317150.683599308, 4078592.8506504213],
          "date_created": "2012-03-20 09:35:49.036377",
          "name": "The Woods",
          "area": 4,
          "county": "Multnomah"
        }
      }]
    };

    $.get('/features/{{user.username}}/workspace-owner.json', function (data) {
      console.dir(data);
    });

    function propertiesViewModel() {
      var self = this;
      // TODO: make function to map properties with test  
      self.propertyList = ko.observableArray($.map(properties.features, function (feature, i) {
        return ko.mapping.fromJS(feature.properties);
      }));

      self.hasProperties = function () { return self.propertyList().length > 0 };

      self.selectedProperty = ko.observable(self.propertyList()[0]);

      self.selectProperty = function (property, event) {
        // TODO: Make active!
        // $(event.target).closest('tr')
        //   .addClass('active')
        //   .siblings().removeClass('active');
        
        self.selectedProperty(property);
      };

      self.showEditForm = function () {
        var formUrl = 'features/forestproperty/{uid}/form/'.replace('{uid}', this.selectedProperty().uid());
        $.get(formUrl, function (data) {
          var $form = $(data).find('form');
          
          // remove the submit button, strip out the geometry
          $form
            .find('input:submit').remove().end()
            .find('#id_geometry_final').closest('.field').remove();

          // put the form in a well and focus the first field
          $form.addClass('well');
          $form.find('input:visible').first().focus();
          
          // show the form in a modal
          $('#modal').modal('show')
            .find('.modal-body').empty().append($form).end()
            .find('.modal-header').find('h3').text('Edit Property');
        })
      };

      self.showAddForm = function () {
        var formUrl = 'features/forestproperty/form/';

        self.selectedProperty({
          "name": ko.observable(),
          "area": 4,
          "county": "Multnomah"
        });
        $.get(formUrl, function (data) {
          var $form = $(data).find('form');
          
          // remove the submit button, strip out the geometry
          $form
            .find('input:submit').remove().end()
            .find('#id_geometry_final').closest('.field').remove();

          // put the form in a well and focus the first field
          $form.addClass('well');
          $form.find('input:visible').first().focus();
          
          // show the form in a modal
          $('#modal').modal('show')
            .find('.modal-body').empty().append($form).end()
            .find('.modal-header').find('h3').text('Add Property');
        })
      };

      self.saveEditForm = function () {
        var $form = $('#modal').find('form'), 
          actionUrl = $form.attr('action'),
          values = {},
          name = $form.find('#id_name').val();

        $form.find('input').each(function () {
          var $input = $(this);
          values[$input.attr('name')] = $input.val();
        });

        $('#modal').modal('hide');
        $.ajax({
          url: actionUrl,
          type: "POST",
          data: values,
          success: function (data, textStatus, jqXHR) {
            self.selectedProperty().name(name);
          }
        });
      };

      self.cancelEditForm = function () {
        $('#modal').modal('hide');
      };

    };

    $(document).ready(function () {
      var onResize = function () {
        $("#map").height($(window).height() * .75);
      };
      $('#modal').modal({'show': false});
      onResize();
      $(window).resize(onResize);
      
      ko.applyBindings(new propertiesViewModel());

    });

    </script>
{% endblock content %}
{% block scripts %}
    <script src="http://maps.google.com/maps/api/js?v=3.5&amp;sensor=false"></script>
    <script src="/media/OpenLayers.js"></script>
    {% load compressed %}
    {% compressed_js 'application' %}
{% endblock scripts %}
