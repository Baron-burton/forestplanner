{% extends 'common/base.html' %}

{% block content %}
   <!-- this should go into a partial -->
      <div class="row-fluid">
        <div class="span4">
          <div><h1>Manage Properties</h1></div>
        </div>
        <div class="span8">
          <span class="pull-right">
            <form class="form-search">
              <input type="text" class="input-large search-query" placeholder="placename or parcel id">
              <button class="btn" type="submit">Search</button>
            </form>
          </span>
        </div>
      </div>
        <div class="row-fluid">
          <div class="span3">
            <ul class="breadcrumb">
              <li>
                <a href="#">Home</a> <span class="divider">/</span>
              </li>
              <li class="active">Properties</li>
            </ul>
            <div class="well"> <!-- need to make this a different color -->
              {% if user.is_authenticated %}
              <div class="row-fluid" data-bind="ifnot: propertyList().length">
                <h2>Create Properties</h2>
                <p><em>You currently have no properties under management.</em></p>
                <div id="properties-none">
                  <h3>Draw your property</h3>
                  <p>Find your properties on the map by searching for a placename or parcel id.</p>
                  <div>
                      <form class="form-search">
                          <input type="text" class="input-large search-query" placeholder="placename or parcel id">
                          <button class="btn" type="submit">Search</button>
                      </form>
                  </div>
                  <p>When your property is in view on the map, click the button below to draw the boundaries of your first property.</p>
                  <h3>Add additional information</h3>
                  <p>Then you will be asked to enter some additional information to help describe your property.</p>
                  <div class="pull-right">
                    <button href="#" class="btn btn-large btn-primary" data-bind="click: startAddDrawing, disable: drawingActivated">Add Property</button>
                  </div>
                </div> <!-- no properties -->
              </div><!-- end of no properties -->
              <div>
                <div id="properties-list" data-bind="if: propertyList().length, visible: showPropertyList">
                  <h2>Property List</h2>
                  <p>
                    <button class="btn" href="#" data-bind="click: zoomToExtent, disable: preventUpdates">Show All Properties</button>
                    <button href="#" class="btn" data-bind="click: startAddDrawing, disable: preventUpdates">Add Property</button>
                  </p>
                  <div class="row-fluid" style="display:none"  data-bind="visible: propertyList().length">
                    <table class="table table-condensed table-bordered">
                      <thead><th>Name</th><th>Area (acres)</th><th>County</th></thead>
                      <tbody data-bind="foreach: propertyList">
                        <tr data-bind="click: $parent.selectProperty">
                          <td><a data-bind="text: name"></a></td>
                          <td><span data-bind="text: acres().toFixed(2)"></span></td>
                          <td><span data-bind="text: location"></span></td>           
                        </tr>
                      </tbody>
                    </table>
                    <div class="pull-right">
                      <button href="#" id="delete-button" class="btn" data-bind="click: showDeleteDialog">delete property</button>
                      <button class="btn btn-primary" href="#" data-bind="click: showEditForm, disable: preventUpdates">Edit Property</button>
                    </div>
                  </div>
                </div><!-- has properties -->
                <div class="row-fluid"><!-- panels -->
                  <div>
                    <div data-bind="if: showDrawHelpPanel">
                      <h2>Drawing Property</h2>
                      <p>Here we should have information about drawing the property and an animated gif</p>
                      <div class="pull-right">
                        <a href="#" class="btn" data-bind="click: cancelEdit">cancel</a>
                      </div>
                    </div>
                    <div data-bind="if: showDetailPanel">
                      <h2>Property Details</h2>
                        <table class="table" data-bind="if: selectedProperty().name">
                          <tr><td>Name</td><td><span data-bind="text: selectedProperty().name"><span></td></tr>
                          <tr><td>Area</td><td><span data-bind="text: selectedProperty().acres().toFixed(2)"></span> acres</td></tr>
                          <tr><td>County</td><td><span data-bind="text: selectedProperty().location"></span></td></tr>
                        </table>
                        <div class="pull-right">
                          <button class="btn" href="#">Perform Analysis</button>
                          <button class="btn" href="#">Add Stands</button>
                        </div>
                      </div>
                    </div>
                    <div class="form-panel" data-bind="if: showEditPanel">
                      <h2>Edit Property</h2>
                      <div id="edit-panel"></div>
                      <div class="pull-right" id="edit-panel-buttons">
                        <a href="#" class="btn" data-bind="click: cancelEdit">cancel</a>
                        <a href="#" class="btn btn-primary" data-bind="click: updateFeature">save changes</a>
                      </div>
                    </div>
                    <div class="form-panel" data-bind="if: showCreatePanel">
                      <h2>Create Property</h2>
                      <div id="create-panel"></div>
                      <div class="pull-right" id="create-panel-buttons">
                        <a href="#" class="btn" data-bind="click: cancelEdit">cancel</a>
                        <a href="#" class="btn btn-primary" data-bind="click: addFeature">create</a>
                      </div>
                    </div>
                  </div>
              </div>
            {% else %} 
               <div class="row-fluid">
                <h2>Login</h2>
                <p><em>You currently not logged in to the Forest Scenario Planner.</em></p>
                <ul>
                  <li><a href="{% url registration_register %}" id="register">Register</a></li>
                  <li><a href="{% url user_signin %}" id="signin">Sign In</a></li>                
                </ul>. 
              </div><!-- end of no properties -->
            {% endif %}
            </div>
          </div>
          <div class="span9">
            <div class="outermap">
              <div id="map"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- end partial -->
     <div class="modal" id="delete-dialog" style="display:none">
      <div class="modal-header">
        <a class="close" data-dismiss="modal">Ã—</a>
        <h3>Delete Property</h3>
      </div>
      <div class="modal-body">
        <div data-bind="if: propertyList().length">
          Are you sure you want to delete "<span data-bind="text: selectedProperty().name"></span>"?
        </div>
      </div>
      <div class="modal-footer">
        <a href="#" class="btn btn-danger" data-bind="click: deleteFeature">Delete property</a>
        <a href="#" class="btn" data-bind="click: closeDialog">cancel</a>
      </div>
    </div>

    <script type="text/javascript">

    // name space for app
    var app = {};

    $.get('/features/{{user.username}}/workspace-owner.json', function (data) {
      app.workspace = data;
    });

    function propertiesViewModel () {
      var self = this;
      // TODO: make function to map properties with test  
      self.propertyList = ko.observableArray();
      self.showEditPanel = ko.observable(false);
      self.showDetailPanel = ko.observable(false);
      self.showCreatePanel = ko.observable(false);
      self.showDrawHelpPanel = ko.observable(false);
      self.drawingActivated = ko.observable(false);
      self.preventUpdates = ko.observable(false);
      self.showPropertyList = ko.observable(true);
      self.selectProperty = function (property, event, zoomTo) {
        var bbox = OpenLayers.Bounds.fromArray(property.bbox());
        // TODO: Make active!
        if (! self.preventUpdates()) {
          if (event) {     
            $(event.target).closest('tr')
              .addClass('active')
              .siblings().removeClass('active');         
              app.selectFeature.unselectAll();
              app.selectFeature.select(property.feature);
          } 
          // set the selected property for the viewmodel
          self.selectedProperty(property);
          self.showDetailPanel(true);
          // zoom the map to the selected property
          // map.zoomToExtent(bounds);
          console.log(map.getZoomForExtent(bbox) - map.zoom );
          if (zoomTo) {
            if (map.getZoomForExtent(bbox) - map.zoom > 1) {
              map.panTo(bbox.getCenterLonLat());
            } else {
              map.zoomToExtent(bbox);        
            }
          }
        }
      };

      self.selectPropertyByUID = function (uid, zoomTo) {
        $.each(self.propertyList(), function (i, property) {
          if (property.uid() === uid) {
            self.selectProperty(property, null, zoomTo);
          }
        });
      };

      self.zoomToExtent = function () {
        map.zoomToExtent(app.bounds);
      }

      self.showEditForm = function () {
        var formUrl = 'features/forestproperty/{uid}/form/'.replace('{uid}', this.selectedProperty().uid());
        $.get(formUrl, function (data) {
          var $form = $(data).find('form');
          
          // remove the submit button, strip out the geometry
          $form
            .find('input:submit').remove().end()
            .find('#id_geometry_final').closest('.field').remove();

          // put the form in a well and focus the first field
          $form.addClass('well');
          $form.find('input:visible').first().focus();
          
          // show the form in the panel
          self.showDetailPanel(false);
          self.showEditPanel(true);
          self.preventUpdates(true);
          $('#edit-panel').empty().append($form);
          app.modifyFeature.selectFeature(self.selectedProperty().feature);
          app.modifyFeature.activate();
          app.viewModel.showPropertyList(false)

        })
      };
      self.startAddDrawing = function () {
        self.showDetailPanel(false);
        self.showDrawHelpPanel(true);
        self.drawingActivated(true);
        self.preventUpdates(true);
        app.drawFeature.activate();
        app.viewModel.showPropertyList(false)
      };
      self.showAddForm = function () {
        var formUrl = 'features/forestproperty/form/';

        $.get(formUrl, function (data) {
          var $form = $(data).find('form');
          
          // remove the submit button, strip out the geometry
          $form
            .find('input:submit').remove().end()
            .find('#id_geometry_final').closest('.field').remove();

          // put the form in a well and focus the first field
          $form.addClass('well');
          $form.find('input:visible').first().focus();
          
          // show the form in a modal
          self.showDetailPanel(false);
          self.showCreatePanel(true);
          $('#create-panel').empty().append($form);
        })
      };

      self.addFeature = function (self, event) {
        self.saveFeature(event, null, app.newGeometry);
        app.drawFeature.deactivate();
        app.new_features.removeAllFeatures()
      };

      self.updateFeature = function (self, event) {
        var geometry = app.modifyFeature.feature.geometry.toString();
        self.saveFeature(event, self.selectedProperty(), geometry);
        app.modifyFeature.deactivate();
        app.new_features.removeAllFeatures();
      };

      self.saveFeature = function (event, property, geometry) {
        var $dialog = $(event.target).closest('.form-panel'),
          $form = $dialog.find('form'), 
          actionUrl = $form.attr('action'),
          values = {};
        $form.find('input').each(function () {
          var $input = $(this);
          values[$input.attr('name')] = $input.val();
        });
        values.geometry_final = geometry;
        $form.addClass('form-horizontal')
        self.showEditPanel(false);
        self.showCreatePanel(false);
        self.preventUpdates(false);
        $.ajax({
          url: actionUrl,
          type: "POST",
          data: values,
          success: function (data, textStatus, jqXHR) {
            // property is not defined if new
            self.updateOrCreateProperty(JSON.parse(data), property);
            self.drawingActivated(false);
            app.viewModel.showPropertyList(true);
          }
        });
      };

      self.updateOrCreateProperty = function (data, property) {
        var updateUrl = 'features/generic-links/links/geojson/{uid}/'.replace('{uid}', data["X-Madrona-Select"]);
        $.get(updateUrl, function (data) {
          var newPropertyVM, newProperty = data.features[0].properties;
          if (property) {
            // updating existing property
            ko.mapping.fromJS(newProperty, property);
            self.selectProperty(property);
          } else {
            // add a new property
            self.selectPropertyByUID(data.features[0].uid)
            app.vector_layer.addFeatures(app.geojson_format.read(data));
          }
        });
      };
      self.showDeleteDialog = function () {
        $("#delete-dialog").modal("show");
      };

      self.deleteFeature = function () {
        var url = "/features/generic-links/links/delete/{uid}/".replace("{uid}", self.selectedProperty().uid());
        $('#delete-dialog').modal('hide');
        self.showEditPanel(false);
        self.showCreatePanel(false);
        self.showDetailPanel(true);
        self.preventUpdates(false);
        $.ajax({
          url: url,
          type: "DELETE",
          success: function (data, textStatus, jqXHR) {
            app.modifyFeature.deactivate();
            app.vector_layer.removeFeatures(self.selectedProperty().feature);
            self.propertyList.remove(self.selectedProperty());
            if (self.propertyList().length) {
              self.selectProperty(self.propertyList()[0]);
             $("#properties-list tbody").find('tr').first().not(':only-child').addClass('active');
            } else {
              self.showDetailPanel(false);
            }
          }
        });
      };

      self.closeDialog = function (self, event) {
         $(event.target).closest(".modal").modal("hide");
      };

      self.cancelEdit = function (self, event) {
        self.showEditPanel(false);
        self.showCreatePanel(false);
        self.showDrawHelpPanel(false);
        self.preventUpdates(false);
        app.modifyFeature.resetVertices();
        app.modifyFeature.deactivate();
        app.drawFeature.deactivate();
        self.showDetailPanel(self.propertyList().length ? true: false);
        app.new_features.removeAllFeatures();
        app.viewModel.showPropertyList(true);

      };

      // initialize properties and vm
      // return request object to apply bindings when done
      self.init = function () {
        return $.get('/trees/user_property_list/', function (data) {
          app.drawFeature.featureAdded = function(feature) { 
            app.drawFeature.deactivate();
            self.showDrawHelpPanel(false);
            app.saveFeature(feature);
          };
          app.bounds = OpenLayers.Bounds.fromArray(data.features.length >0 ? data.bbox: 
            [-13954802.50397, 5681411.4375898, -13527672.389972, 5939462.8450446]);
          map.zoomToExtent(app.bounds);
          // bind event to selected feature
          app.vector_layer.events.on({
            'featureselected': function (feature) {
              self.selectPropertyByUID(feature.feature.data.uid, true);
            },
            'featureadded': function (feature) {
              var featureViewModel = ko.mapping.fromJS(feature.feature.data);
              // save a reference to the feature
              featureViewModel.feature = feature.feature;
              // add it to the viewmodel
              app.viewModel.propertyList.unshift(featureViewModel);
            },
            'featuresadded': function (data) {
              // if only adding one layer, select and zoom
              // otherwise just select the last one and zoom to the full extent of the layer
              if (data.features.length === 1) {
                self.selectPropertyByUID(data.features[0].data.uid, true);
              } else {
                self.selectPropertyByUID(data.features[data.features.length-1].data.uid, false);                
                map.zoomToExtent(app.bounds);         
              }
            }
          });

          
          // select the first property and show the detail panel
          if (data.features.length) {
            app.vector_layer.addFeatures(app.geojson_format.read(data));
            //self.selectedProperty(self.propertyList()[0]);
            self.showDetailPanel(true);   
          }
        });  
      }
      self.selectedProperty = ko.observable();
      self.actionPanelType = ko.observable(false);
    };

    app.viewModel = new propertiesViewModel();

    app.saveFeature = function (f) {
      app.newGeometry = f.geometry.toString();
      app.viewModel.showAddForm();
    };

    app.onResize = function () {
      $("#map").height($(window).height() * .85);
      map.render('map');
    };
    
    $(document).ready(function () {
      app.onResize();

      app.viewModel.init()
        .done(function () {
          // apply the viewmodel
          ko.applyBindings(app.viewModel);
        })
        .fail(function () {
          map.zoomToExtent(OpenLayers.Bounds.fromArray([-13954802.50397, 5681411.4375898, -13527672.389972, 5939462.8450446]));
          ko.applyBindings(app.viewModel);
        });


      
      $(window).resize(app.onResize);
    });

    </script>
{% endblock content %}
{% block scripts %}
    <script src="http://maps.google.com/maps/api/js?v=3.5&amp;sensor=false"></script>
    <script src="{{MEDIA_URL}}OpenLayers.js"></script>
    {% load compressed %}
    {% compressed_js 'application' %}
{% endblock scripts %}
